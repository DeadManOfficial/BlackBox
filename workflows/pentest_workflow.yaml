# BlackBox AI - Pentest Workflow
# ================================
# Structured penetration testing workflow aligned with methodology.

name: "Standard Pentest Workflow"
version: "1.0.0"
description: "Six-phase penetration testing methodology"

# Reference authorized scope
scope_file: "../config/authorized_scope.yaml"

phases:
  # ==========================================================================
  # PHASE 1: RECONNAISSANCE
  # ==========================================================================
  P1_RECON:
    name: "Reconnaissance"
    description: "Information gathering and target enumeration"
    duration_estimate: "1-2 days"

    objectives:
      - "Map attack surface"
      - "Identify technologies and frameworks"
      - "Enumerate endpoints and APIs"
      - "Gather intelligence on target infrastructure"

    tools:
      passive:
        - name: "subfinder"
          command: "subfinder -d {domain} -o subdomains.txt"
          purpose: "Subdomain enumeration"

        - name: "amass"
          command: "amass enum -passive -d {domain}"
          purpose: "Passive DNS enumeration"

        - name: "gau"
          command: "gau {domain} | tee urls.txt"
          purpose: "URL discovery from archives"

        - name: "waybackurls"
          command: "waybackurls {domain} | tee wayback.txt"
          purpose: "Historical URL discovery"

      active:
        - name: "httpx"
          command: "httpx -l subdomains.txt -o alive.txt -status-code -title"
          purpose: "HTTP probing and status checking"

        - name: "nmap"
          command: "nmap -sV -sC -p- -oA nmap_full {target}"
          purpose: "Port scanning and service detection"

    outputs:
      - "subdomains.txt"
      - "alive_hosts.txt"
      - "technologies.json"
      - "api_endpoints.txt"

    checklist:
      - "Subdomain enumeration complete"
      - "Port scan complete"
      - "Technology stack identified"
      - "API endpoints documented"
      - "Attack surface mapped"

  # ==========================================================================
  # PHASE 2: SCANNING & ENUMERATION
  # ==========================================================================
  P2_SCANNING:
    name: "Scanning & Enumeration"
    description: "Vulnerability scanning and service enumeration"
    duration_estimate: "2-3 days"
    depends_on: ["P1_RECON"]

    objectives:
      - "Identify vulnerabilities"
      - "Enumerate services and versions"
      - "Map application structure"
      - "Discover hidden endpoints"

    tools:
      vulnerability_scanning:
        - name: "nuclei"
          command: "nuclei -l alive.txt -t nuclei-templates/ -severity high,critical -o nuclei.txt"
          purpose: "Template-based vulnerability scanning"

        - name: "nikto"
          command: "nikto -h {target} -o nikto.txt"
          purpose: "Web server vulnerability scanning"

      content_discovery:
        - name: "gobuster"
          command: "gobuster dir -u {url} -w wordlist.txt -o gobuster.txt"
          purpose: "Directory and file bruteforcing"

        - name: "ffuf"
          command: "ffuf -u {url}/FUZZ -w wordlist.txt -o ffuf.json -of json"
          purpose: "Fast web fuzzer"

        - name: "feroxbuster"
          command: "feroxbuster -u {url} -w wordlist.txt -o ferox.txt"
          purpose: "Recursive content discovery"

      api_scanning:
        - name: "kiterunner"
          command: "kr scan {url} -w routes.kite -o kiterunner.txt"
          purpose: "API endpoint discovery"

        - name: "arjun"
          command: "arjun -u {url} -o arjun.json"
          purpose: "HTTP parameter discovery"

    outputs:
      - "vulnerabilities.json"
      - "directories.txt"
      - "api_routes.json"
      - "parameters.json"

    checklist:
      - "Nuclei scan complete"
      - "Directory bruteforce complete"
      - "API endpoints enumerated"
      - "Parameters discovered"
      - "Findings documented"

  # ==========================================================================
  # PHASE 3: VULNERABILITY ASSESSMENT
  # ==========================================================================
  P3_ASSESSMENT:
    name: "Vulnerability Assessment"
    description: "Detailed vulnerability analysis and validation"
    duration_estimate: "2-3 days"
    depends_on: ["P2_SCANNING"]

    objectives:
      - "Validate discovered vulnerabilities"
      - "Assess exploitability"
      - "Determine impact and severity"
      - "Prioritize targets"

    focus_areas:
      # From authorized scope
      - target: "Ingestion API & Upload Flow"
        tests:
          - "Upload validation bypass"
          - "Signed URL manipulation"
          - "Content-type mismatch"
          - "File extension filtering"

      - target: "Logging & Monitoring"
        tests:
          - "Debug endpoint exposure"
          - "Verbose error messages"
          - "Stack trace leakage"
          - "Log injection"

    tools:
      manual_testing:
        - name: "burpsuite"
          purpose: "Intercepting proxy for manual testing"

        - name: "caido"
          purpose: "Modern web security testing"

      specialized:
        - name: "sqlmap"
          command: "sqlmap -u '{url}' --batch --level 3 --risk 2"
          purpose: "SQL injection testing"

        - name: "xsstrike"
          command: "xsstrike -u '{url}'"
          purpose: "XSS vulnerability detection"

        - name: "ssrfmap"
          command: "ssrfmap -r request.txt"
          purpose: "SSRF exploitation"

    outputs:
      - "validated_vulns.json"
      - "exploit_chains.md"
      - "risk_assessment.md"

    checklist:
      - "All high/critical findings validated"
      - "Exploitability assessed"
      - "Impact documented"
      - "Risk ratings assigned"

  # ==========================================================================
  # PHASE 4: EXPLOITATION
  # ==========================================================================
  P4_EXPLOITATION:
    name: "Exploitation"
    description: "Controlled exploitation of validated vulnerabilities"
    duration_estimate: "2-4 days"
    depends_on: ["P3_ASSESSMENT"]

    objectives:
      - "Develop proof of concepts"
      - "Demonstrate impact"
      - "Chain vulnerabilities"
      - "Document exploitation steps"

    focus_areas:
      # From authorized scope - Tier 3
      - target: "Captioning & Styling Engine"
        attack_vectors:
          - "Font path traversal"
          - "SVG injection"
          - "External resource loading"
          - "LFI via styling"

      - target: "Social Publishing OAuth"
        attack_vectors:
          - "State parameter manipulation"
          - "Token replay"
          - "Cross-account binding"
          - "Scope escalation"

    tools:
      exploitation:
        - name: "metasploit"
          purpose: "Exploitation framework"

        - name: "custom_exploits"
          purpose: "Targeted exploit development"

      payload_generation:
        - name: "blackbox payloads"
          command: "blackbox payloads shellcode {type} --lhost {ip}"
          purpose: "Generate attack payloads"

    safety_rules:
      - "No data exfiltration beyond POC"
      - "No service disruption"
      - "Document all actions"
      - "Use isolated test accounts"

    outputs:
      - "poc_scripts/"
      - "exploitation_log.md"
      - "impact_demonstration.md"

    checklist:
      - "POCs developed and tested"
      - "Impact demonstrated"
      - "Exploitation documented"
      - "Evidence captured"

  # ==========================================================================
  # PHASE 5: FORENSIC ANALYSIS
  # ==========================================================================
  P5_FORENSIC:
    name: "Forensic Analysis"
    description: "Deep analysis and evidence collection"
    duration_estimate: "1-2 days"
    depends_on: ["P4_EXPLOITATION"]

    objectives:
      - "Collect forensic evidence"
      - "Analyze system behavior"
      - "Map data flows"
      - "Identify additional attack paths"

    focus_areas:
      # From authorized scope - Tier 3/4
      - target: "Clip Generation Service"
        analysis:
          - "Timeline data flow"
          - "Cross-tenant references"
          - "clip_id to video_id mapping"
          - "Authorization boundaries"

      - target: "Final Render & Export"
        analysis:
          - "Signed URL generation"
          - "TTL and expiry handling"
          - "Access control validation"
          - "URL predictability"

      - target: "Job Queue & Workers"
        analysis:
          - "Job ID lifecycle"
          - "Queue isolation"
          - "Cross-tenant boundaries"
          - "Retry mechanisms"

    tools:
      analysis:
        - name: "js_analyze"
          command: "blackbox scan js-analyze {url}"
          purpose: "JavaScript analysis for secrets and endpoints"

        - name: "traffic_analysis"
          purpose: "Network traffic capture and analysis"

    outputs:
      - "forensic_evidence/"
      - "data_flow_diagrams/"
      - "additional_findings.json"

    checklist:
      - "Evidence collected and preserved"
      - "Data flows documented"
      - "Additional paths identified"
      - "Forensic report drafted"

  # ==========================================================================
  # PHASE 6: ADVANCED EXPLOITATION
  # ==========================================================================
  P6_ADVANCED:
    name: "Advanced Exploitation"
    description: "Complex attack chains and high-value targets"
    duration_estimate: "3-5 days"
    depends_on: ["P5_FORENSIC"]

    objectives:
      - "Execute complex attack chains"
      - "Target high-value systems"
      - "Demonstrate business impact"
      - "Achieve maximum severity findings"

    focus_areas:
      # From authorized scope - Tier 4/5
      - target: "AI Analysis Pipeline (ASR/NLP)"
        attack_vectors:
          - "Prompt injection"
          - "Model manipulation"
          - "Scoring system abuse"
          - "Data leakage via transcription"
        tier: "Tier 5: $75k-$500k+"

      - target: "Identity & Authorization"
        attack_vectors:
          - "Privilege escalation chains"
          - "Shadow admin discovery"
          - "Service account abuse"
          - "RBAC bypass"
        tier: "Tier 5: $75k-$500k+"

      - target: "Transcoding & Normalization Engine"
        attack_vectors:
          - "FFmpeg vulnerabilities"
          - "Playlist injection"
          - "Subtitle parsing exploits"
          - "SSRF via media processing"
        tier: "Tier 4: $25k-$500k"

    tools:
      ai_security:
        - name: "llm_redteam"
          command: "blackbox ai redteam {endpoint}"
          purpose: "LLM red teaming"

        - name: "prompt_injection"
          purpose: "Prompt injection testing"

      privilege_escalation:
        - name: "auth_bypass"
          purpose: "Authorization bypass testing"

    outputs:
      - "advanced_pocs/"
      - "attack_chains.md"
      - "business_impact.md"

    checklist:
      - "High-value targets tested"
      - "Attack chains documented"
      - "Business impact demonstrated"
      - "Maximum severity achieved"

# ==========================================================================
# REPORTING
# ==========================================================================
reporting:
  format: "markdown"
  sections:
    - "Executive Summary"
    - "Methodology"
    - "Scope and Limitations"
    - "Findings by Severity"
    - "Technical Details"
    - "Proof of Concepts"
    - "Remediation Recommendations"
    - "Appendices"

  severity_ratings:
    critical:
      cvss: "9.0-10.0"
      color: "red"
      sla: "24 hours"
    high:
      cvss: "7.0-8.9"
      color: "orange"
      sla: "72 hours"
    medium:
      cvss: "4.0-6.9"
      color: "yellow"
      sla: "7 days"
    low:
      cvss: "0.1-3.9"
      color: "blue"
      sla: "30 days"
    informational:
      cvss: "0.0"
      color: "gray"
      sla: "90 days"
